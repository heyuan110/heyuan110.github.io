<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SQLite æ•°æ®åº“æŸ¥çœ‹å™¨</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #1a1a2e;
            color: #eee;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            padding: 20px 0;
            border-bottom: 1px solid #333;
            margin-bottom: 20px;
        }

        header h1 {
            color: #00d9ff;
            font-size: 28px;
            margin-bottom: 10px;
        }

        header p {
            color: #888;
            font-size: 14px;
        }

        .upload-area {
            border: 2px dashed #444;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            margin-bottom: 20px;
            transition: all 0.3s;
            background: #16213e;
        }

        .upload-area:hover {
            border-color: #00d9ff;
            background: #1a2744;
        }

        .upload-area.dragover {
            border-color: #00d9ff;
            background: #1a2744;
        }

        .upload-btn {
            background: linear-gradient(135deg, #00d9ff, #0099cc);
            color: #000;
            border: none;
            padding: 12px 30px;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.2s;
        }

        .upload-btn:hover {
            transform: scale(1.05);
        }

        .upload-area p {
            margin-top: 15px;
            color: #666;
        }

        .main-content {
            display: none;
            gap: 20px;
        }

        .main-content.active {
            display: grid;
            grid-template-columns: 250px 1fr;
        }

        .sidebar {
            background: #16213e;
            border-radius: 12px;
            padding: 15px;
            height: fit-content;
            max-height: calc(100vh - 200px);
            overflow-y: auto;
        }

        .sidebar h3 {
            color: #00d9ff;
            font-size: 14px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #333;
        }

        .table-list {
            list-style: none;
        }

        .table-list li {
            padding: 10px 12px;
            margin-bottom: 5px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .table-list li:hover {
            background: #1a2744;
        }

        .table-list li.active {
            background: #00d9ff22;
            color: #00d9ff;
        }

        .table-list li::before {
            content: "ğŸ“‹";
            font-size: 14px;
        }

        .table-info {
            font-size: 11px;
            color: #666;
            margin-left: auto;
        }

        .content-area {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .query-section {
            background: #16213e;
            border-radius: 12px;
            padding: 20px;
        }

        .query-section h3 {
            color: #00d9ff;
            font-size: 14px;
            margin-bottom: 15px;
        }

        .query-input {
            width: 100%;
            height: 120px;
            background: #0f0f23;
            border: 1px solid #333;
            border-radius: 8px;
            color: #fff;
            padding: 15px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 14px;
            resize: vertical;
        }

        .query-input:focus {
            outline: none;
            border-color: #00d9ff;
        }

        .query-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #00d9ff, #0099cc);
            color: #000;
        }

        .btn-secondary {
            background: #333;
            color: #fff;
        }

        .btn-success {
            background: linear-gradient(135deg, #00ff88, #00cc6a);
            color: #000;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff4757, #cc3a47);
            color: #fff;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .results-section {
            background: #16213e;
            border-radius: 12px;
            padding: 20px;
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .results-header h3 {
            color: #00d9ff;
            font-size: 14px;
        }

        .results-info {
            color: #666;
            font-size: 12px;
        }

        .table-container {
            overflow: auto;
            max-height: 500px;
            border-radius: 8px;
            border: 1px solid #333;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        th {
            background: #0f0f23;
            color: #00d9ff;
            padding: 12px 15px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
            border-bottom: 2px solid #00d9ff33;
        }

        td {
            padding: 10px 15px;
            border-bottom: 1px solid #333;
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        tr:hover td {
            background: #1a2744;
        }

        td.null-value {
            color: #666;
            font-style: italic;
        }

        .schema-view {
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 13px;
            background: #0f0f23;
            padding: 15px;
            border-radius: 8px;
            overflow: auto;
            max-height: 400px;
        }

        .schema-view .column {
            padding: 8px 0;
            border-bottom: 1px solid #222;
        }

        .schema-view .column:last-child {
            border-bottom: none;
        }

        .schema-view .col-name {
            color: #00d9ff;
            font-weight: 600;
        }

        .schema-view .col-type {
            color: #ff9f43;
            margin-left: 10px;
        }

        .schema-view .col-pk {
            color: #ff4757;
            margin-left: 10px;
            font-size: 11px;
        }

        .schema-view .col-notnull {
            color: #feca57;
            margin-left: 10px;
            font-size: 11px;
        }

        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
        }

        .tab {
            padding: 8px 16px;
            background: #0f0f23;
            border: 1px solid #333;
            border-radius: 6px;
            cursor: pointer;
            color: #888;
            font-size: 13px;
            transition: all 0.2s;
        }

        .tab:hover {
            color: #fff;
            border-color: #444;
        }

        .tab.active {
            background: #00d9ff22;
            border-color: #00d9ff;
            color: #00d9ff;
        }

        .message {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .message.error {
            background: #ff475722;
            border: 1px solid #ff4757;
            color: #ff6b7a;
        }

        .message.success {
            background: #00ff8822;
            border: 1px solid #00ff88;
            color: #00ff88;
        }

        .message.info {
            background: #00d9ff22;
            border: 1px solid #00d9ff;
            color: #00d9ff;
        }

        .db-info {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .db-info-item {
            background: #16213e;
            padding: 15px 20px;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .db-info-item label {
            font-size: 11px;
            color: #666;
            text-transform: uppercase;
        }

        .db-info-item span {
            font-size: 18px;
            font-weight: 600;
            color: #00d9ff;
        }

        .history-section {
            margin-top: 20px;
        }

        .history-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .history-item {
            padding: 8px 12px;
            background: #0f0f23;
            border-radius: 4px;
            margin-bottom: 5px;
            font-family: monospace;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .history-item:hover {
            background: #1a2744;
            color: #00d9ff;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
        }

        .pagination button {
            padding: 8px 15px;
            background: #333;
            border: none;
            border-radius: 4px;
            color: #fff;
            cursor: pointer;
        }

        .pagination button:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .pagination span {
            color: #888;
            font-size: 13px;
        }

        .export-dropdown {
            position: relative;
            display: inline-block;
        }

        .export-menu {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            background: #16213e;
            border: 1px solid #333;
            border-radius: 6px;
            margin-top: 5px;
            z-index: 100;
            min-width: 150px;
        }

        .export-menu.show {
            display: block;
        }

        .export-menu button {
            display: block;
            width: 100%;
            padding: 10px 15px;
            background: none;
            border: none;
            color: #fff;
            text-align: left;
            cursor: pointer;
            font-size: 13px;
        }

        .export-menu button:hover {
            background: #1a2744;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #333;
            border-top-color: #00d9ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .empty-state::before {
            content: "ğŸ“­";
            font-size: 48px;
            display: block;
            margin-bottom: 15px;
        }

        /* å¿«æ·é”®æç¤º */
        .shortcuts {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #16213e;
            padding: 15px;
            border-radius: 8px;
            font-size: 12px;
            color: #666;
            border: 1px solid #333;
        }

        .shortcuts kbd {
            background: #0f0f23;
            padding: 2px 6px;
            border-radius: 3px;
            border: 1px solid #444;
            color: #00d9ff;
        }

        @media (max-width: 900px) {
            .main-content.active {
                grid-template-columns: 1fr;
            }

            .sidebar {
                max-height: 200px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ—„ï¸ SQLite æ•°æ®åº“æŸ¥çœ‹å™¨</h1>
            <p>åœ¨æµè§ˆå™¨ä¸­ç›´æ¥æŸ¥çœ‹å’ŒæŸ¥è¯¢ SQLite æ•°æ®åº“æ–‡ä»¶</p>
        </header>

        <div class="upload-area" id="uploadArea">
            <input type="file" id="fileInput" accept=".db,.sqlite,.sqlite3,.db3" style="display: none;">
            <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                ğŸ“‚ é€‰æ‹©æ•°æ®åº“æ–‡ä»¶
            </button>
            <p>æˆ–å°† .db / .sqlite æ–‡ä»¶æ‹–æ”¾åˆ°æ­¤å¤„</p>
            <p style="margin-top: 10px; font-size: 12px;">æ”¯æŒæ ¼å¼: .db, .sqlite, .sqlite3, .db3</p>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>æ­£åœ¨åŠ è½½æ•°æ®åº“...</p>
        </div>

        <div class="db-info" id="dbInfo"></div>

        <div class="main-content" id="mainContent">
            <aside class="sidebar">
                <h3>ğŸ“‘ æ•°æ®è¡¨</h3>
                <ul class="table-list" id="tableList"></ul>
            </aside>

            <div class="content-area">
                <section class="query-section">
                    <h3>ğŸ’» SQL æŸ¥è¯¢</h3>
                    <textarea class="query-input" id="queryInput" placeholder="è¾“å…¥ SQL æŸ¥è¯¢è¯­å¥...&#10;ä¾‹å¦‚: SELECT * FROM table_name LIMIT 100"></textarea>
                    <div class="query-actions">
                        <button class="btn btn-primary" onclick="executeQuery()">
                            â–¶ï¸ æ‰§è¡ŒæŸ¥è¯¢ (Ctrl+Enter)
                        </button>
                        <button class="btn btn-secondary" onclick="formatQuery()">
                            ğŸ¨ æ ¼å¼åŒ–
                        </button>
                        <button class="btn btn-secondary" onclick="clearQuery()">
                            ğŸ—‘ï¸ æ¸…ç©º
                        </button>
                        <div class="export-dropdown">
                            <button class="btn btn-success" onclick="toggleExportMenu()">
                                ğŸ“¥ å¯¼å‡ºç»“æœ
                            </button>
                            <div class="export-menu" id="exportMenu">
                                <button onclick="exportCSV()">ğŸ“„ å¯¼å‡ºä¸º CSV</button>
                                <button onclick="exportJSON()">ğŸ“‹ å¯¼å‡ºä¸º JSON</button>
                                <button onclick="exportSQL()">ğŸ—ƒï¸ å¯¼å‡ºä¸º SQL</button>
                            </div>
                        </div>
                    </div>

                    <div class="history-section" id="historySection" style="display: none;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <h4 style="color: #888; font-size: 12px;">ğŸ“œ æŸ¥è¯¢å†å² <span style="color: #00d9ff;" id="historyCount"></span></h4>
                            <button class="btn btn-secondary" onclick="clearHistory()" style="padding: 4px 8px; font-size: 11px;">ğŸ—‘ï¸ æ¸…ç©º</button>
                        </div>
                        <div class="history-list" id="historyList"></div>
                    </div>
                </section>

                <section class="results-section">
                    <div class="results-header">
                        <div class="tabs">
                            <button class="tab active" data-tab="data" onclick="switchTab('data')">ğŸ“Š æ•°æ®</button>
                            <button class="tab" data-tab="schema" onclick="switchTab('schema')">ğŸ”§ ç»“æ„</button>
                        </div>
                        <span class="results-info" id="resultsInfo"></span>
                    </div>

                    <div id="messageArea"></div>

                    <div id="dataTab" class="tab-content">
                        <div class="table-container" id="tableContainer">
                            <div class="empty-state">é€‰æ‹©ä¸€ä¸ªè¡¨æˆ–æ‰§è¡ŒæŸ¥è¯¢ä»¥æŸ¥çœ‹æ•°æ®</div>
                        </div>
                        <div class="pagination" id="pagination" style="display: none;">
                            <button onclick="prevPage()">â—€ ä¸Šä¸€é¡µ</button>
                            <span id="pageInfo">ç¬¬ 1 é¡µ</span>
                            <button onclick="nextPage()">ä¸‹ä¸€é¡µ â–¶</button>
                        </div>
                    </div>

                    <div id="schemaTab" class="tab-content" style="display: none;">
                        <div class="schema-view" id="schemaView">
                            <div class="empty-state">é€‰æ‹©ä¸€ä¸ªè¡¨ä»¥æŸ¥çœ‹ç»“æ„</div>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </div>

    <div class="shortcuts">
        <kbd>Ctrl</kbd> + <kbd>Enter</kbd> æ‰§è¡ŒæŸ¥è¯¢ &nbsp;|&nbsp;
        <kbd>F5</kbd> åˆ·æ–°æ•°æ®åº“
    </div>

    <script>
        // å…¨å±€å˜é‡
        let db = null;
        let currentTable = null;
        let currentResults = [];
        let currentColumns = [];
        let queryHistory = [];
        let currentPage = 1;
        const pageSize = 100;
        let currentFile = null;  // ä¿å­˜å½“å‰åŠ è½½çš„æ–‡ä»¶å¼•ç”¨
        const STORAGE_KEY = 'sqlite_viewer_history';  // localStorage é”®å

        // åˆå§‹åŒ– SQL.js
        let SQL = null;
        initSqlJs({ locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${file}` })
            .then(function(sql) {
                SQL = sql;
                console.log('SQL.js åŠ è½½å®Œæˆ');
                // ä» localStorage åŠ è½½å†å²è®°å½•
                loadHistoryFromStorage();
            });

        // æ–‡ä»¶ä¸Šä¼ å¤„ç†
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file) loadDatabase(file);
        });

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) loadDatabase(file);
        });

        // åŠ è½½æ•°æ®åº“
        async function loadDatabase(file) {
            if (!SQL) {
                showMessage('SQL.js æ­£åœ¨åŠ è½½ï¼Œè¯·ç¨å€™...', 'info');
                return;
            }

            showLoading(true);
            currentFile = file;  // ä¿å­˜æ–‡ä»¶å¼•ç”¨ç”¨äºåˆ·æ–°

            try {
                const arrayBuffer = await file.arrayBuffer();
                const uint8Array = new Uint8Array(arrayBuffer);

                db = new SQL.Database(uint8Array);

                // è·å–è¡¨åˆ—è¡¨
                const tables = db.exec("SELECT name FROM sqlite_master WHERE type='table' AND name NOT LIKE 'sqlite_%' ORDER BY name");

                if (tables.length === 0 || tables[0].values.length === 0) {
                    showMessage('æ•°æ®åº“ä¸­æ²¡æœ‰æ‰¾åˆ°è¡¨', 'error');
                    showLoading(false);
                    return;
                }

                // æ˜¾ç¤ºæ•°æ®åº“ä¿¡æ¯
                showDbInfo(file, tables[0].values.length);

                // æ˜¾ç¤ºè¡¨åˆ—è¡¨
                showTableList(tables[0].values);

                // æ˜¾ç¤ºä¸»ç•Œé¢
                document.getElementById('uploadArea').style.display = 'none';
                document.getElementById('mainContent').classList.add('active');

                showMessage(`æˆåŠŸåŠ è½½æ•°æ®åº“: ${file.name}`, 'success');

            } catch (error) {
                showMessage(`åŠ è½½æ•°æ®åº“å¤±è´¥: ${error.message}`, 'error');
            }

            showLoading(false);
        }

        // åˆ·æ–°æ•°æ®åº“
        async function refreshDatabase() {
            if (!currentFile) {
                showMessage('æ²¡æœ‰å·²åŠ è½½çš„æ•°æ®åº“æ–‡ä»¶', 'error');
                return;
            }

            showLoading(true);

            try {
                // é‡æ–°è¯»å–æ–‡ä»¶
                const arrayBuffer = await currentFile.arrayBuffer();
                const uint8Array = new Uint8Array(arrayBuffer);

                // å…³é—­æ—§æ•°æ®åº“ï¼Œåˆ›å»ºæ–°æ•°æ®åº“
                if (db) db.close();
                db = new SQL.Database(uint8Array);

                // è·å–è¡¨åˆ—è¡¨
                const tables = db.exec("SELECT name FROM sqlite_master WHERE type='table' AND name NOT LIKE 'sqlite_%' ORDER BY name");

                // æ›´æ–°è¡¨åˆ—è¡¨
                showTableList(tables[0]?.values || []);

                // æ›´æ–°æ•°æ®åº“ä¿¡æ¯
                showDbInfo(currentFile, tables[0]?.values.length || 0);

                // å¦‚æœå½“å‰æœ‰é€‰ä¸­çš„è¡¨ï¼Œåˆ·æ–°æ•°æ®
                if (currentTable) {
                    selectTable(currentTable);
                }

                const now = new Date().toLocaleTimeString();
                showMessage(`âœ“ æ•°æ®åº“å·²åˆ·æ–° (${now})`, 'success');

            } catch (error) {
                showMessage(`åˆ·æ–°å¤±è´¥: ${error.message}`, 'error');
            }

            showLoading(false);
        }

        // æ˜¾ç¤ºæ•°æ®åº“ä¿¡æ¯
        function showDbInfo(file, tableCount) {
            const dbInfo = document.getElementById('dbInfo');
            const sizeKB = (file.size / 1024).toFixed(2);
            const sizeMB = (file.size / 1024 / 1024).toFixed(2);
            const sizeDisplay = file.size > 1024 * 1024 ? `${sizeMB} MB` : `${sizeKB} KB`;

            dbInfo.innerHTML = `
                <div class="db-info-item">
                    <label>æ–‡ä»¶å</label>
                    <span style="font-size: 14px;">${file.name}</span>
                </div>
                <div class="db-info-item">
                    <label>æ–‡ä»¶å¤§å°</label>
                    <span>${sizeDisplay}</span>
                </div>
                <div class="db-info-item">
                    <label>è¡¨æ•°é‡</label>
                    <span>${tableCount}</span>
                </div>
                <div class="db-info-item" style="justify-content: center;">
                    <button class="btn btn-primary" onclick="refreshDatabase()" style="margin-bottom: 5px;">
                        ğŸ”„ åˆ·æ–°æ•°æ®
                    </button>
                    <button class="btn btn-secondary" onclick="document.getElementById('fileInput').click()" style="font-size: 12px;">
                        ğŸ“‚ æ›´æ¢æ–‡ä»¶
                    </button>
                </div>
            `;
        }

        // æ˜¾ç¤ºè¡¨åˆ—è¡¨
        function showTableList(tables) {
            const tableList = document.getElementById('tableList');
            tableList.innerHTML = '';

            tables.forEach(([tableName]) => {
                // è·å–è¡Œæ•°
                const countResult = db.exec(`SELECT COUNT(*) FROM "${tableName}"`);
                const rowCount = countResult[0]?.values[0][0] || 0;

                const li = document.createElement('li');
                li.innerHTML = `${tableName}<span class="table-info">${rowCount} è¡Œ</span>`;
                li.onclick = () => selectTable(tableName);
                tableList.appendChild(li);
            });
        }

        // é€‰æ‹©è¡¨
        function selectTable(tableName) {
            currentTable = tableName;
            currentPage = 1;

            // æ›´æ–°é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.table-list li').forEach(li => {
                li.classList.toggle('active', li.textContent.startsWith(tableName));
            });

            // æ˜¾ç¤ºè¡¨æ•°æ®
            const query = `SELECT * FROM "${tableName}" LIMIT ${pageSize} OFFSET 0`;
            document.getElementById('queryInput').value = query;

            executeQuery(query);
            showTableSchema(tableName);
        }

        // æ˜¾ç¤ºè¡¨ç»“æ„
        function showTableSchema(tableName) {
            const schemaView = document.getElementById('schemaView');
            const pragmaResult = db.exec(`PRAGMA table_info("${tableName}")`);

            if (pragmaResult.length === 0) {
                schemaView.innerHTML = '<div class="empty-state">æ— æ³•è·å–è¡¨ç»“æ„</div>';
                return;
            }

            let html = '';
            pragmaResult[0].values.forEach(col => {
                const [cid, name, type, notnull, defaultVal, pk] = col;
                html += `
                    <div class="column">
                        <span class="col-name">${name}</span>
                        <span class="col-type">${type || 'ANY'}</span>
                        ${pk ? '<span class="col-pk">PRIMARY KEY</span>' : ''}
                        ${notnull ? '<span class="col-notnull">NOT NULL</span>' : ''}
                        ${defaultVal !== null ? `<span style="color:#666; margin-left:10px;">DEFAULT: ${defaultVal}</span>` : ''}
                    </div>
                `;
            });

            // è·å–ç´¢å¼•ä¿¡æ¯
            const indexResult = db.exec(`PRAGMA index_list("${tableName}")`);
            if (indexResult.length > 0 && indexResult[0].values.length > 0) {
                html += '<div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #333;"><strong style="color: #ff9f43;">ç´¢å¼•:</strong></div>';
                indexResult[0].values.forEach(idx => {
                    html += `<div class="column" style="color: #888;">ğŸ“‘ ${idx[1]} ${idx[2] ? '(UNIQUE)' : ''}</div>`;
                });
            }

            schemaView.innerHTML = html;
        }

        // æ‰§è¡ŒæŸ¥è¯¢
        function executeQuery(customQuery = null) {
            const query = customQuery || document.getElementById('queryInput').value.trim();

            if (!query) {
                showMessage('è¯·è¾“å…¥ SQL æŸ¥è¯¢è¯­å¥', 'error');
                return;
            }

            if (!db) {
                showMessage('è¯·å…ˆåŠ è½½æ•°æ®åº“', 'error');
                return;
            }

            try {
                const startTime = performance.now();
                const results = db.exec(query);
                const endTime = performance.now();
                const duration = (endTime - startTime).toFixed(2);

                if (results.length === 0) {
                    showMessage(`æŸ¥è¯¢æ‰§è¡ŒæˆåŠŸï¼Œæ— è¿”å›æ•°æ® (${duration}ms)`, 'success');
                    currentResults = [];
                    currentColumns = [];
                    showResults([], []);
                    return;
                }

                const { columns, values } = results[0];
                currentColumns = columns;
                currentResults = values;

                showResults(columns, values);
                document.getElementById('resultsInfo').textContent =
                    `${values.length} è¡Œ Â· ${duration}ms`;

                // æ·»åŠ åˆ°å†å²
                addToHistory(query);

            } catch (error) {
                showMessage(`æŸ¥è¯¢é”™è¯¯: ${error.message}`, 'error');
            }
        }

        // æ˜¾ç¤ºç»“æœ
        function showResults(columns, values) {
            const container = document.getElementById('tableContainer');

            if (columns.length === 0) {
                container.innerHTML = '<div class="empty-state">æ— æ•°æ®</div>';
                document.getElementById('pagination').style.display = 'none';
                return;
            }

            // åˆ†é¡µæ˜¾ç¤º
            const startIdx = (currentPage - 1) * pageSize;
            const endIdx = Math.min(startIdx + pageSize, values.length);
            const pageData = values.slice(startIdx, endIdx);
            const totalPages = Math.ceil(values.length / pageSize);

            let html = '<table><thead><tr>';
            html += '<th>#</th>';
            columns.forEach(col => {
                html += `<th>${escapeHtml(col)}</th>`;
            });
            html += '</tr></thead><tbody>';

            pageData.forEach((row, idx) => {
                html += '<tr>';
                html += `<td style="color:#666;">${startIdx + idx + 1}</td>`;
                row.forEach(cell => {
                    if (cell === null) {
                        html += '<td class="null-value">NULL</td>';
                    } else {
                        const cellStr = String(cell);
                        const displayStr = cellStr.length > 100 ? cellStr.substring(0, 100) + '...' : cellStr;
                        html += `<td title="${escapeHtml(cellStr)}">${escapeHtml(displayStr)}</td>`;
                    }
                });
                html += '</tr>';
            });

            html += '</tbody></table>';
            container.innerHTML = html;

            // åˆ†é¡µæ§åˆ¶
            const pagination = document.getElementById('pagination');
            if (totalPages > 1) {
                pagination.style.display = 'flex';
                document.getElementById('pageInfo').textContent = `ç¬¬ ${currentPage} / ${totalPages} é¡µ`;
                pagination.querySelector('button:first-child').disabled = currentPage === 1;
                pagination.querySelector('button:last-child').disabled = currentPage === totalPages;
            } else {
                pagination.style.display = 'none';
            }
        }

        // åˆ†é¡µæ§åˆ¶
        function prevPage() {
            if (currentPage > 1) {
                currentPage--;
                showResults(currentColumns, currentResults);
            }
        }

        function nextPage() {
            const totalPages = Math.ceil(currentResults.length / pageSize);
            if (currentPage < totalPages) {
                currentPage++;
                showResults(currentColumns, currentResults);
            }
        }

        // åˆ‡æ¢æ ‡ç­¾
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

            document.getElementById('dataTab').style.display = tabName === 'data' ? 'block' : 'none';
            document.getElementById('schemaTab').style.display = tabName === 'schema' ? 'block' : 'none';
        }

        // ä» localStorage åŠ è½½å†å²è®°å½•
        function loadHistoryFromStorage() {
            try {
                const stored = localStorage.getItem(STORAGE_KEY);
                if (stored) {
                    queryHistory = JSON.parse(stored);
                    updateHistoryDisplay();
                    console.log(`å·²ä» localStorage åŠ è½½ ${queryHistory.length} æ¡å†å²è®°å½•`);
                }
            } catch (e) {
                console.error('åŠ è½½å†å²è®°å½•å¤±è´¥:', e);
                queryHistory = [];
            }
        }

        // ä¿å­˜å†å²è®°å½•åˆ° localStorage
        function saveHistoryToStorage() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(queryHistory));
            } catch (e) {
                console.error('ä¿å­˜å†å²è®°å½•å¤±è´¥:', e);
            }
        }

        // æ·»åŠ åˆ°å†å²
        function addToHistory(query) {
            // å¦‚æœå·²å­˜åœ¨ï¼Œç§»åˆ°æœ€å‰é¢
            const existingIndex = queryHistory.indexOf(query);
            if (existingIndex > -1) {
                queryHistory.splice(existingIndex, 1);
            }

            queryHistory.unshift(query);
            if (queryHistory.length > 50) queryHistory.pop();  // ä¿ç•™æ›´å¤šå†å²

            updateHistoryDisplay();
            saveHistoryToStorage();  // ä¿å­˜åˆ° localStorage
        }

        function updateHistoryDisplay() {
            const historySection = document.getElementById('historySection');
            const historyList = document.getElementById('historyList');
            const historyCount = document.getElementById('historyCount');

            if (queryHistory.length === 0) {
                historySection.style.display = 'none';
                return;
            }

            historySection.style.display = 'block';
            historyCount.textContent = `(${queryHistory.length}æ¡)`;
            historyList.innerHTML = queryHistory.map((q, idx) =>
                `<div class="history-item" onclick="loadHistoryByIndex(${idx})" title="${escapeHtml(q)}">
                    <span style="color:#666;margin-right:8px;">${idx + 1}.</span>${escapeHtml(q.length > 80 ? q.substring(0, 80) + '...' : q)}
                </div>`
            ).join('');
        }

        function loadHistoryByIndex(index) {
            if (index >= 0 && index < queryHistory.length) {
                document.getElementById('queryInput').value = queryHistory[index];
            }
        }

        function loadHistory(query) {
            document.getElementById('queryInput').value = query.replace(/&amp;/g, '&').replace(/&lt;/g, '<').replace(/&gt;/g, '>').replace(/&quot;/g, '"');
        }

        // æ¸…ç©ºå†å²è®°å½•
        function clearHistory() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æŸ¥è¯¢å†å²å—ï¼Ÿ')) {
                queryHistory = [];
                updateHistoryDisplay();
                saveHistoryToStorage();
                showMessage('å†å²è®°å½•å·²æ¸…ç©º', 'success');
            }
        }

        // æ ¼å¼åŒ–æŸ¥è¯¢
        function formatQuery() {
            const input = document.getElementById('queryInput');
            let query = input.value;

            // ç®€å•æ ¼å¼åŒ–
            const keywords = ['SELECT', 'FROM', 'WHERE', 'AND', 'OR', 'ORDER BY', 'GROUP BY', 'HAVING', 'LIMIT', 'OFFSET', 'JOIN', 'LEFT JOIN', 'RIGHT JOIN', 'INNER JOIN', 'ON', 'INSERT INTO', 'VALUES', 'UPDATE', 'SET', 'DELETE FROM'];

            query = query.replace(/\s+/g, ' ').trim();
            keywords.forEach(kw => {
                const regex = new RegExp(`\\b${kw}\\b`, 'gi');
                query = query.replace(regex, `\n${kw}`);
            });

            input.value = query.trim();
        }

        // æ¸…ç©ºæŸ¥è¯¢
        function clearQuery() {
            document.getElementById('queryInput').value = '';
        }

        // å¯¼å‡ºåŠŸèƒ½
        function toggleExportMenu() {
            const menu = document.getElementById('exportMenu');
            menu.classList.toggle('show');
        }

        // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­èœå•
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.export-dropdown')) {
                document.getElementById('exportMenu').classList.remove('show');
            }
        });

        function exportCSV() {
            if (currentResults.length === 0) {
                showMessage('æ²¡æœ‰æ•°æ®å¯å¯¼å‡º', 'error');
                return;
            }

            let csv = currentColumns.map(c => `"${c}"`).join(',') + '\n';
            currentResults.forEach(row => {
                csv += row.map(cell => {
                    if (cell === null) return '';
                    const str = String(cell).replace(/"/g, '""');
                    return `"${str}"`;
                }).join(',') + '\n';
            });

            downloadFile(csv, 'export.csv', 'text/csv;charset=utf-8');
            document.getElementById('exportMenu').classList.remove('show');
        }

        function exportJSON() {
            if (currentResults.length === 0) {
                showMessage('æ²¡æœ‰æ•°æ®å¯å¯¼å‡º', 'error');
                return;
            }

            const data = currentResults.map(row => {
                const obj = {};
                currentColumns.forEach((col, idx) => {
                    obj[col] = row[idx];
                });
                return obj;
            });

            const json = JSON.stringify(data, null, 2);
            downloadFile(json, 'export.json', 'application/json');
            document.getElementById('exportMenu').classList.remove('show');
        }

        function exportSQL() {
            if (currentResults.length === 0 || !currentTable) {
                showMessage('æ²¡æœ‰æ•°æ®å¯å¯¼å‡º', 'error');
                return;
            }

            let sql = '';
            currentResults.forEach(row => {
                const values = row.map(cell => {
                    if (cell === null) return 'NULL';
                    if (typeof cell === 'number') return cell;
                    return `'${String(cell).replace(/'/g, "''")}'`;
                }).join(', ');
                sql += `INSERT INTO "${currentTable}" (${currentColumns.map(c => `"${c}"`).join(', ')}) VALUES (${values});\n`;
            });

            downloadFile(sql, 'export.sql', 'text/sql');
            document.getElementById('exportMenu').classList.remove('show');
        }

        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        // å·¥å…·å‡½æ•°
        function showMessage(text, type) {
            const area = document.getElementById('messageArea');
            area.innerHTML = `<div class="message ${type}">${escapeHtml(text)}</div>`;
            setTimeout(() => {
                area.innerHTML = '';
            }, 5000);
        }

        function showLoading(show) {
            document.getElementById('loading').classList.toggle('active', show);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // å¿«æ·é”®
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'Enter') {
                executeQuery();
            }
            // F5 åˆ·æ–°æ•°æ®åº“
            if (e.key === 'F5' && currentFile) {
                e.preventDefault();
                refreshDatabase();
            }
        });
    </script>
</body>
</html>
